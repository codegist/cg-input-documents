<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../cg-base/cg-required-validator.html">
<link rel="import" href="../cg-base/cg-validatable-behavior.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../cg-behaviors/cg-base-behavior.html">
<link rel="import" href="../cg-behaviors/cg-application-datasource-aware-behavior.html">
<link rel="import" href="../cg-behaviors/cg-application-event-listener-behavior.html">
<link rel="import" href="../cg-behaviors/cg-application-context-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../cg-input-tags/cg-input-tags.html">
<link rel="import" href="../cg-utils/cg-utils.html">
<link rel="import" href="../cg-link/cg-link.html">
<link rel="import" href="../cg-task-upload/cg-task-upload-factory.html">
<link rel="import" href="../font-awesome-polymer-icons/fa-icons.html">

<link rel="import" href="../dropzone/dist/min/dropzone.min.css">
<script src="../dropzone/dist/min/dropzone.min.js"></script>

<dom-module is="cg-input-documents">
    <style>
        :host {
            @apply(--paper-font-body1);
            width:100%;
            display: block;
        }
        .doc-wrapper #listScroller {
            height:250px;
            overflow:auto;
            z-index: 0;
        }
        .doc-wrapper .doc-type {
            width:16px;
            height:16px;
            color:#454545;
        }

        .doc-wrapper .doc-upload-retry ::content iron-icon,
        .doc-wrapper .doc-upload-success-icon {
            width:16px;
            height:16px;
            color:#46C82A;
        }
        .doc-wrapper .message-icon,
        .doc-wrapper .doc-upload-error-icon,
        .doc-wrapper .doc-size-warning {
            width:16px;
            height:16px;
            color:#FFD811;
        }


        .doc-wrapper .doc-upload-retry,
        .doc-wrapper .doc-del {
            padding:2px;
            margin:0px 5px;
        }
        .doc-wrapper .doc-del ::content iron-icon {
            width:16px;
            height:16px;
            color:#d34336;
        }

        .doc-wrapper .doc-desc {
            padding:3px 0px 0px 0px;
            margin:0px 0px 5px 0px;
            color:#606060;
            font-size:13px;
            min-width:200px;
        }
        .doc-wrapper .doc-desc ::content * {
            padding:0px;
            margin:0px!important;
        }

        .doc-wrapper .doc-categories {
            padding:3px 0px 0px 0px;
            margin:0px;
            color:#606060;
            font-size:13px;
        }
        .doc-wrapper .doc-categories ::content .tags .tag {
            padding:0px;
            margin:3px;
        }
        .doc-wrapper .message-icon,
        .doc-wrapper .message-text,
        .doc-wrapper .doc-type,
        .doc-wrapper .doc-name,
        .doc-wrapper .doc-desc,
        .doc-wrapper .doc-size-warning,
        .doc-wrapper .doc-size,
        .doc-wrapper .doc-link,
        .doc-wrapper .doc-new{
            margin-right:10px;
        }
        .doc-wrapper .doc-upload-error-icon,
        .doc-wrapper .doc-upload-success-icon {
            margin-right:5px;
        }
        .doc-wrapper .doc-footer {
            margin-top:5px;
            margin-bottom:5px;
            height:10px;
        }

        .doc-wrapper .transfer-success .doc-upload-progressbar {
            background-color: #46C82A;
        }

        .doc-wrapper .transfer-error .doc-upload-progressbar {
            background-color: #d34336;
        }

        .doc-wrapper .doc-upload-progressbar{
            height:10px;
            background-color: #A7ACE5;
            border-radius: 5px;
        }
        .doc-wrapper .doc-upload-progress-percent{
            width:30px;
            margin-left:5px;
            margin-right:5px;
        }
        .doc-wrapper .doc-added,
        .doc-wrapper .doc-upload-retry,
        .doc-wrapper .doc-upload-progress-percent,
        .doc-wrapper .doc-upload-error,
        .doc-wrapper .doc-upload-error-label,
        .doc-wrapper .doc-upload-success,
        .doc-wrapper .doc-size {
            color:#454545;
            font-size:12px;
        }
        .doc-wrapper .doc-upload-error {
            color:#d34336;
        }
        .doc-wrapper .document {
            padding:10px;
        }
        .doc-wrapper .document:hover {
            /*background-color:#dddddd;*/
        }
        .doc-wrapper .document .doc-name:hover {
            text-decoration: underline;
            cursor:pointer;
        }
        .doc-wrapper .doc-new {
            color:#ee0000;
            font-size:12px;
            font-style:italic;
        }
        .doc-wrapper .message {
            margin-bottom:5px;
        }
        .doc-wrapper .add-doc {
            color: #4285f4;
        }
        .doc-wrapper .add-doc span {
            margin:5px;
        }
        .doc-wrapper .drag-empty {
            text-align: center;
            padding:30px;
        }
        .doc-wrapper .drag-empty .big {
            @apply(--paper-font-display2);
            color: #8B8B8B;
            margin:0px;
        }
        .doc-wrapper .label {
            font-size: 0.75em;
            color:#757575;
            padding-bottom:5px;
        }
        .doc-wrapper .counts {
            margin-top:10px;
        }
        .doc-wrapper .result-count {
            color:#6A6A6A;
            font-size:12px;
            margin:0px 5px;
            text-align: right;
        }
        .doc-wrapper .spacer {
            height:40px;
        }
        .doc-wrapper {
            @apply(--layout-vertical);
        }
        .doc-wrapper #dragzone {
            @apply(--layout-vertical);
            @apply(--layout-relative);
        }
        .doc-wrapper #dragzone .panelwrap {
            @apply(--layout-fit);
        }
        .doc-wrapper #dragzone .counts {
            @apply(--layout-horizontal);
            @apply(--layout-end-justified);
        }
        .doc-wrapper #dragzone .document {
            @apply(--layout-vertical);
            z-index: 0;
        }
        .doc-wrapper #dragzone .document .doc-wrapper {
            @apply(--layout-horizontal);
        }
        .doc-wrapper #dragzone .document .doc-infos {
            @apply(--layout-horizontal);
            @apply(--layout-flex);
            @apply(--layout-wrap);
        }
        .doc-wrapper #dragzone .document .doc-desc {
            @apply(--layout-flex);
        }
        .doc-wrapper #dragzone .document .doc-footer {
            @apply(--layout-horizontal);
            @apply(--layout-wrap);
        }
        .doc-wrapper #dragzone .doc-upload-progressbar-wrapper {
            @apply(--layout-flex);
            @apply(--layout-self-center);
        }
        .doc-wrapper #dragzone .doc-upload-error-wrapper {
            @apply(--layout-horizontal);
        }
        .doc-wrapper .messages {
            @apply(--layout-vertical);
        }
        .doc-wrapper .messages .message {
            @apply(--layout-horizontal);
        }
    </style>
    <template>
        <cg-required-validator required="[[required]]"></cg-required-validator>
        <div class="doc-wrapper">
            <div class="label" hidden$="[[nolabel]]">[[label]]</div>
            <div id="dragzone" on-dragover="_onDragOver" on-dragleave="_onDragLeave" on-drop="_onDrop">
                <paper-material elevation="1" class="panelwrap"></paper-material>
                <div class="counts">
                    <span class="result-count">[[displayCount(documents.length)]]</span>
                </div>
                <input type="file" name="file" is="iron-input" required$="[[required]]" hidden id="input"/>
                <div id="listScroller" hidden$="[[!isGreaterThan(documents.length, 0)]]" >
                    <template is="dom-repeat" items="[[documents]]" sort="sortDocs">
                        <div class="document" on-input="_onInput">
                            <div class="doc-wrapper">
                                <div class="doc-infos">
                                    <div>
                                        <iron-icon class="doc-type" icon="[[_displayMimeIcon(item.type)]]"></iron-icon>
                                        <span class="doc-added" hidden$="[[!showAdded]]">[[_displayAdded(item.updatedAt)]]</span>
                                        <span class="doc-name"><a href$="[[downloadLink(item)]]">[[item.name]]</a></span><!--TODO REMOVE THAT PATH FROM HERE -->
                                        <span class="doc-size">[[_displaySize(item.size)]]</span>
                                        <iron-icon hidden$="[[!isGreaterThan(item.size, warningSize)]]" class="doc-size-warning" title="This document is quite big!" icon="fa:exclamation-circle"></iron-icon>
                                        <cg-link hidden$="[[!item.link]]" class="doc-link" link="[[item.link]]" link-source="[[item]]" source="[[self]]"></cg-link>
                                        <span hidden$="[[isDefined(item.handle)]]" class="doc-new">New</span>
                                    </div>
                                    <paper-input label="Description" value="{{item.description}}" class="doc-desc" no-label-float="true"></paper-input>
                                </div>
                                <div>
                                    <paper-icon-button class="doc-del" icon="fa:minus-circle" on-tap="_onDeleteDocument"></paper-icon-button>
                                </div>
                            </div>
                            <div>
                                <cg-input-tags class="doc-categories" tags="[[categories]]" label="Categories" selected="{{item.categories}}"></cg-input-tags>
                            </div>
                            <div hidden$="[[!item.processing.progress]]" class$="[[computeProgressClass(item.processing.finished,item.processing.success)]]">
                                <div class="doc-upload-progressbar-wrapper">
                                    <paper-material class="doc-upload-progressbar" elevation="1" style$="[[concat('width:', item.processing.progress, '%;')]]"></paper-material>
                                </div>
                                <div class="doc-upload-progress-percent">[[_displayProgress(item.processing.progress)]]</div>
                                <div class="doc-upload-error-wrapper" hidden$="[[!isProcessingCompletedUnsuccessful(item.processing.finished, item.processing.success)]]">
                                    <iron-icon class="doc-upload-error-icon" icon="fa:exclamation-triangle"></iron-icon>
                                    <span class="doc-upload-error-label">Transfer failed:&nbsp;</span>
                                    <span class="doc-upload-error" hidden$="[[!item.processing.canceled]]">cancelled by user</span>
                                    <span class="doc-upload-error" hidden$="[[item.processing.canceled]]">Server error</span>
                                    <div><paper-icon-button class="doc-upload-retry" icon="fa:repeat" on-tap="_retryUpload">retry</paper-icon-button></div>
                                </div>
                                <div hidden$="[[falses(item.processing.finished, item.processing.success)]]">
                                    <iron-icon class="doc-upload-success-icon" icon="fa:check-circle-o"></iron-icon>
                                    <span class="doc-upload-success">Document transferred</span>
                                </div>
                            </div>
                        </div>
                    </template>
                    <div class="spacer"></div>
                </div>
                <div class$="[[ifEqualsTo(documents.length, 0, 'drag-empty', '')]]">
                    <p hidden$="[[isGreaterThan(documents.length, 0)]]" class="big">Drag files here</p>
                    <p hidden$="[[isGreaterThan(documents.length, 0)]]" class="big">or</p>
                    <div>
                        <paper-button id="addbutton" class="add-doc">
                            <iron-icon icon="fa:files-o"></iron-icon>
                            <span hidden$="[[!isGreaterThan(documents.length, 0)]]">Select files from your computer</span>
                            <span hidden$="[[isGreaterThan(documents.length, 0)]]">Add documents</span>
                        </paper-button>
                    </div>
                </div>
                <!-- TODO CHECK on-core-overlay-close-completed -->
                <paper-toast id="messages" on-core-overlay-close-completed="_discardMessages" duration="[[computeToastDuration(_messages.length, 3000)]]">
                    <div class="messages">
                        <template is="dom-repeat" items="[[_messages]]" as="m">
                            <div class="message">
                                <iron-icon hidden$="[[!m.icon]]" class="message-icon" icon="[[m.icon]]"></iron-icon>
                                <span class="message-text">[[m.text]]</span>
                            </div>
                        </template>
                    </div>
                </paper-toast>
            </div>
        </div>
    </template>
</dom-module>
<script>
    (function(){
        var CGFileManager = function(){

        };
        CGFileManager.prototype = {
            defaultIcon :"fa:file-o",
            iconsMimeKeyWords :{
                "fa:file-pdf-o":["pdf"],
                "fa:file-image-o":["image"],
                "fa:file-word-o":["word"],
                "fa:file-archive-o":["zip", "rar", "compressed"],
                "fa:file-text-o":["text"],
                "fa:file-video-o":["video"],
                "fa:file-audio-o":["audio"],
                "fa:file-excel-o":["excel"],
                "fa:file-powerpoint-o":["powerpoint"],
            },
            getIconForMime:function(mime){
                if(mime) {
                    for (var icon in this.iconsMimeKeyWords) {
                        var keywords = this.iconsMimeKeyWords[icon];
                        for (var i = 0; i < keywords.length; i++) {
                            if (mime.indexOf(keywords[i]) != -1) {
                                return icon;
                            }
                        }
                    }
                }
                return this.defaultIcon;
            }
        };
        Polymer({
            is:"cg-input-documents",
            properties:{
                uploadUrl:String,
                categories:Array,
                refreshOnApplicationEvents:Array,
                documents:{
                    type:Array,
                    value:[],
                    observer:'documentsChanged',
                    notify:true
                },
                cgName:{
                    value:"documents"
                },
                nolabel:{
                    type:Boolean,
                    value:false
                },
                showAdded:{
                    type:Boolean,
                    value:false
                },
                required:{
                    type:Boolean,
                    value:false
                },
                autoUpload:{
                    type:Boolean,
                    value:false,
                    observer:'autoUploadChanged'
                },
                autoSave:{
                    type:Boolean,
                    value:false
                },
                warningSize:{
                    type:Number,
                    value:1024*1024*10
                },
                label:{
                    type:String,
                    value:"Documents"
                },
                locale:{
                    type:String,
                    value:window.navigator.userLanguage || window.navigator.language
                },
                autoSaveDelay:{
                    type:Number,
                    value:3000
                },
                _selection:Object,
                _dropzone:Object,
                _deletedDocuments:{
                    type:Array,
                    value:[]
                },
                _messages:{
                    type:Array,
                    value:[]
                },
                _addedFormat:{
                    type:Intl.DateTimeFormat,
                    value:function(){
                        return Intl.DateTimeFormat(this.locale, {day:'2-digit', month:'2-digit', year:'numeric'})
                    }
                },
                _cgFileManager:{
                    type:CGFileManager,
                    value:new CGFileManager()
                },
                validator:{
                    type:String,
                    value:"cg-required-validator"
                }
            },
            behaviors:[CG.BaseBehavior, CG.ApplicationDataSourceAwareBehavior, CG.ApplicationEventListenerBehavior, CG.ValidatableBehavior, CG.ApplicationContextBehavior],
            observers:[
                "documentsChanged(documents.*)"
            ],
            ready:function(){
                this.uploadUrl = this.get("config.uploadUrl", this.context) || this.uploadUrl;
                this._dropzone = new Dropzone(this.querySelectRoot("#dragzone"), {
                    url: this.uploadUrl || "#",
                    autoProcessQueue: false,
//                    autoProcessQueue: this.autoUpload, // TODO CHECK THIS
                    previewsContainer:false,
                    uploadMultiple:false,
//                        maxFilesize:16,
                    clickable:this.$.addbutton,
                    dictFileTooBig: "File \"{{filename}}\" is too big ({{filesize}}MiB). Max file size: {{maxFilesize}}MiB."
                });
//                    this._dropzone.on("uploadprogress", function(file,a,b,c,d) {
                this._dropzone.on("addedfile", function(file) {
                    this._dropzone.accept(file, function(error) {
                        this._dropzone.removeAllFiles();
                        this._onDocAdded(file, error ? error.replace("{{filename}}", file.name) : error);
                        var uploadTask = CGUploadTaskFactory.task(this.uploadUrl, file, function(event, data, task, file){
                            var doc = this._getDocByHandle(file);
                            if(!doc) return;
                            switch(event){
                                case "start":
                                    var processing = {
                                        progress:0,
                                        bytes:0,
                                        finished:false,
                                        success:null,
                                        canceled:null,
                                        data:null
                                    };
                                    doc.model.processing = processing;
                                    this._setDocumentProperty(doc.index, "processing", processing);
                                    break;
                                case "progress":
                                    this._setDocumentProperty(doc.index, "processing.progress", data.progress);
                                    console.log(this.toString(), "uploadprogress", doc.model.name, "/", data.progress);
                                    break;
                                case "finished":
                                    if(data.success) {
                                        this._setDocumentProperty(doc.index, "processing.finished", true);
                                        this._setDocumentProperty(doc.index, "processing.success", true);
                                    }else if(data.canceled){
                                        this._setDocumentProperty(doc.index, "processing.finished", true);
                                        this._setDocumentProperty(doc.index, "processing.success", false);
                                        this._setDocumentProperty(doc.index, "processing.canceled", true);
                                    }else {
                                        console.log(this.toString(), "error" , doc.model.name);
                                        this._setDocumentProperty(doc.index, "processing.finished", true);
                                        this._setDocumentProperty(doc.index, "processing.success", false);
                                        this._setDocumentProperty(doc.index, "processing.data", data);
                                    }
                                    break;
                            }
                        }.bind(this));
                        var saveTask = new Task("Save document " + file.name, function(task, doc, context){
                            task.progress(50);
                            this.onUploadCompleted(doc.model, task.dependsOn.info.data, context, function(success, response){
                                if(success) {
                                    task.success(response.data);
                                }else{
                                    task.error(response.data);
                                }
                            });
                        }, [this._getDocByHandle(file), CG.Utils.Objects.clone(false, {}, this.dataContext)], this, function(){}, uploadTask);
                        this.fireDocument("cg-tasks", "schedule-tasks", [uploadTask, saveTask]);
                    }.bind(this));
                }.bind(this));

                if(this.categories == null) {
                    this.fireDataRequest({
                        type:"documents/categories/data", typePrefix:false,
                        success:function(response){
                            this.categories = response.data;
                        }.bind(this),
                        failure:function(response){}.bind(this)
                    });
                }
                this.reload();
            },
            downloadLink:function(model){
                return "#"
            },
            autoUploadChanged:function(){
                if(this._dropzone) {
                    this._dropzone.options.autoProcessQueue = this.autoUpload;
                }
            },
            _displayMimeIcon:function(mime){
                return this._cgFileManager.getIconForMime(mime);
            },
            _displayAdded:function(added){
                return this._addedFormat.format(added);
            },
            displayCount:function(total){
                return CG.Utils.Displays.countFound("document", "documents", total);
            },
            computeProgressClass:function(processingFinished, processingSuccess){
                return "doc-footer " + (processingFinished === true ? processingSuccess === true ? 'transfer-success' : 'transfer-error' : '');
            },
            computeToastDuration:function(length, base){
                return length * base;
            },
            isProcessingCompletedUnsuccessful:function(finished, success){
                return finished == true && success == false;
            },
            sortDocs:function(a,b){
                if(!a.updatedAt || !b.updatedAt) {
                    return 0;
                }
                var at = a.updatedAt.getTime();
                var bt = b.updatedAt.getTime();
                return at < bt ? 1 : at > bt ? -1 : 0;
            },
            documentsChanged:function(oldValue, newValue){
                var internalChange = (newValue === undefined);
                if(!this.documents) {
                    this._deletedDocuments.splice(0, this._deletedDocuments.length);
                    return true;
                }

                for(var i =0; i<this.documents.length;i++){
                    var doc = this.documents[i];
                    doc._cgId = doc._cgId || this.genId();
                    doc.categories = doc.categories || [];
                }
                if(!internalChange) {
                    this._deletedDocuments.splice(0, this._deletedDocuments.length);
                }
            },
            _displayProgress:function(progress) {
                return Math.round(progress) + "%";
            },
            _displaySize:function(size){
                return CG.Utils.Formats.number(size, "0.00 b");
            },
            uploadUrlChanged:function(){
                if(this._dropzone) {
                    this._dropzone.options.url = this.uploadUrl;
                }
            },
            _setDocumentProperty:function(index, prop, value){
                this.set("documents." + index + "." + prop, value)
            },
            _retryUpload:function(e){
                this.cancelEvent(e);
                var doc = this._getDocFromEvent(e);
                this._setDocumentProperty(this.documents.indexOf(doc), "processing", null);
                this._dropzone.processFile(doc.handle);
            },
            startUpload:function() {
                this._dropzone.processQueue();
            },
            refresh:function(){
                if(this.isDataAware()) {
                    console.log(this.toString(), "no documents provided firing data request");
                    this.reload();
                }else{
                    console.log(this.toString(), "documents provided, using them");
                }
            },
            _getDocFromEvent:function(e){
                return e.model.item;
            },
            _onDeleteDocument:function(e){
                this.cancelEvent(e);
                this.deleteDocument(this._getDocFromEvent(e), this.autoSave);
            },
            deleteDocument:function(doc, force, completeCallback){
                this.cancelScheduledSave(doc);
                if(force && this.isDataAware()) {
                    this.fireDataRequest({
                        type:"document/delete", typePrefix:false,
                        params:{document:doc},
                        success:function(response){
                            this._commitDeleteDoc(doc);
                            this.fireApplicationEvent("document-deleted", response.data);
                            completeCallback && completeCallback(response);
                        }.bind(this),
                        failure:function(response){
                            completeCallback && completeCallback(response);
                        }.bind(this)
                    });
                }else{
                    this._commitDeleteDoc(doc, true);
                }
            },
            _commitDeleteDoc:function(doc, rememberDeleted){
                if(doc.handle) {
                    this._dropzone.removeFile(doc.handle);
                }
                if(!this.documents) {
                    return;
                }
                var index = this.documents.indexOf(doc);
                index != -1 && this.splice("documents", this.documents.indexOf(doc), 1);
                if(rememberDeleted === true) {
                    this._deletedDocuments.push(doc);
                }
                this.fire("input", doc);
            },
            onUploadCompleted:function(doc, response, context, completeCallback){
                doc.file = response.file;
                doc.hash = response.hash;
                doc._dirty = true;
                this.onDocumentAutoSave(doc, true, context, completeCallback);
            },
            _onInput:function(e){
                this.scheduleSave(e.model.item);
            },
            cancelScheduledSave:function(doc){
                this.cancelDebouncer("autosave_" + doc._cgId);
            },
            scheduleSave:function(doc){
                doc._dirty = true;
                this.debounce("autosave_" + doc._cgId, function(){
                    this.onDocumentAutoSave(doc);
                }, this.autoSaveDelay);
            },
            onDocumentAutoSave:function(doc, force, context, completeCallback){
                if(!this.autoSave) {
                    console.log(this.toString(), "Autosave disabled, ignoring request");
                    return;
                }
                if(force !== true && doc.handle) {
                    console.log(this.toString(), "document is new, waiting for upload to complete before saving.");
                    return;
                }
                this.saveDocument(doc, context, completeCallback);
            },
            saveDocuments:function(completeCallback){
                var toSave = this._deletedDocuments.length;
                this.documents && this.documents.forEach(function(doc){
                    if(doc._dirty) {
                        toSave++;
                    }
                }, this);
                if(toSave == 0) {
                    return completeCallback && completeCallback([]);
                }

                var responses = [];
                var callback = function(response){
                    responses.push(response.data || response);
                    if(responses.length == toSave) {
                        completeCallback && completeCallback(responses);
                    }
                };
                this.documents && this.documents.forEach(function(doc){
                    this.saveDocument(doc, callback);
                }, this);
                for(var i = this._deletedDocuments.length - 1; i>=0;i--){
                    this.deleteDocument(this._deletedDocuments[i], true, callback);
                    this._deletedDocuments.splice(i, 1);
                }
            },
            deleteAllDocuments:function(completeCallback){
                this._deletedDocuments = this._deletedDocuments.concat(this.documents);
                this.splice("documents", 0, this.documents.length);
                this.saveDocuments(completeCallback);
            },
            replaceDocument:function(index, doc){
                this.documents[index] = doc;
            },
            saveDocument:function(doc, context, completeCallback){
                if(doc._dirty) {
                    var transactionType = doc.handle ? "create" : "update";
                    this.fireDataRequest({
                        type:"document/save", typePrefix:false,
                        params:{document:doc, context:context},
                        success:function(response){
                            response.data.processing = doc.processing;
                            this.replaceDocument(this.documents.indexOf(doc), response.data);
                            switch(transactionType) {
                                case "create":
                                    this.fireApplicationEvent("document-created", response.data);
                                    break;
                                case "update":
                                    this.fireApplicationEvent("document-updated", response.data);
                                    break;
                            }
                            this.fire("input", doc);
                            completeCallback && completeCallback(true, response);
                        }.bind(this),
                        failure:function(response){
                            completeCallback && completeCallback(false, response);
                        }.bind(this)
                    });
                }else{
                    console.log(this.toString(), "document is unchanged, ignoring save request.");
                }
            },
            onDataContextChanged:function(){
                this.reload(); // todo inject conditions to reload on contextChangedPath
            },
            reload:function(){
                this.fireDataRequest({
                    type:"data",
                    success:function(response){
                        this.documents = response.data;
                    }.bind(this),
                    failure:function(response){}.bind(this)
                });
            },
            _onDocAdded:function(file, error){
                if(error) {
                    if (this._async != undefined) {
                        this.cancelAsync(this._async);
                    }
                    this._messages.push({
                        icon:"fa:exclamation-circle",
                        text:error
                    });
                    this._async = this.async(function () {
                        this._showMessages();
                    }.bind(this), null, 10);
                }else {
                    this.push("documents", {
                        name: file.name,
                        description:"",
                        size: file.size,
                        type: file.type,
                        categories:[],
                        createdAt:new Date(),
                        updatedAt:new Date(),
                        handle: file
                    });
                }
            },
            _getDocByHandle:function(handle) {
                for(var i=0; i<this.documents.length;i++){
                    if(this.documents[i].handle == handle) {
                        return {
                            index:i,
                            model:this.documents[i]
                        };
                    }
                }
                return null;
            },
            _discardMessages:function(){
                this._messages = [];
            },
            _showMessages:function(){
                this.$.messages.show();
            },
            onApplicationEvent:function(type, event){
                if(this.refreshOnApplicationEvents && this.refreshOnApplicationEvents.indexOf(type) != -1) {
                    console.log(this.toString(), "onApplicationEvent(type:'" , type , "') received, trigger data refresh");
                    this.refresh();
                }
            },
        });
    })()
</script>