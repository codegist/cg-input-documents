<link href="../polymer/polymer.html" rel="import">
<link href="../paper-shadow/paper-shadow.html" rel="import">
<link href="../paper-button/paper-button.html" rel="import">
<link href="../core-icon/core-icon.html" rel="import">
<link href="../core-icon-button/core-icon-button.html" rel="import">
<link href="../core-list/core-list.html" rel="import">
<link href="../cg-lightdom-element/cg-lightdom-element.html" rel="import">
<link href="../font-awesome-polymer-icons/fa-icons.html" rel="import" >

<polymer-element name="cg-input-documents" extends="cg-lightdom-element" attributes="label documents colors selected required">
    <template>
        <style>
            cg-input-documents {
                width:100%;
                font-family: sans-serif;
            }
            #dragzone {
                border:1px solid black;
            }
            core-list {
                height:200px;
            }
            .doc-type {
                width:16px!important;
                height:16px!important;
                color:#454545;
            }

            .doc-size-warning {
                width:16px!important;
                height:16px!important;
                color:#FFD811;
            }

            .doc-del {
                padding:2px!important;
                margin:0px!important;
            }
            .doc-del /deep/ core-icon {
                width:16px!important;
                height:16px!important;
                color:#ee0000;
            }
            .doc-type,
            .doc-name,
            .doc-size{
                margin-right:10px;
            }
            .doc-size {
                color:#454545;
                font-size:12px;
            }
            .document {
                padding:10px;
            }
            .document:hover {
                background-color:#dddddd;
            }
            .document:hover .doc-name {
                text-decoration: underline;
                cursor:pointer;
            }
            .doc-new {
                color:#ee0000;
                font-size:12px;
                font-style:italic;
            }



        </style>
        <div id="dragzone" on-dragover="{{_onDragOver}}" on-dragleave="{{_onDragLeave}}" on-drop="{{_onDrop}}">
            <input type="file" directory is="core-input" required?="{{required}}" hidden id="input" multiple="multiple" on-change="{{_onDrop}}"/>
            <template if="{{documents.length == 0}}">
                <paper-button on-click="{{_selectFiles}}">Select files from computer</paper-button>
                or drag files here
            </template>
            <template if="{{documents.length > 0}}">
                <core-list id="list" data="{{documents}}" selectionEnabled="true" selection="{{selection}}" height="80" flex multi layout>
                    <template>
                        <div class="document" layout horizontal>
                            <div flex layout horizontal>
                                <core-icon class="doc-type" icon="{{model.type | _displayMimeIcon}}"></core-icon>
                                <span class="doc-name">{{model.name}}</span>
                                <span class="doc-size">{{model.size | _displaySize}}</span>
                                <template if="{{model.size >= warningSize}}">
                                    <core-icon class="doc-size-warning" title="This document is quite big!" icon="fa:exclamation-circle"></core-icon>
                                </template>
                                <template if="{{model.handle}}">
                                    <span class="doc-new">New</span>
                                </template>
                            </div>
                            <core-icon-button class="doc-del" icon="fa:minus-circle" on-tap="{{_deleteDoc}}" data-name="{{model.name}}"></core-icon-button>
                        </div>
                    </template>
                </core-list>
                <paper-button on-click="{{_selectFiles}}">Add more files</paper-button>
            </template>
        </div>


    </template>
    <script>
        var CGFileManager = function(){

        };
        CGFileManager.prototype = {
            defaultIcon :"fa:file-o",
            iconsMimeKeyWords :{
                "fa:file-pdf-o":["pdf"],
                "fa:file-image-o":["image"],
                "fa:file-word-o":["word"],
                "fa:file-archive-o":["zip", "rar", "compressed"],
                "fa:file-text-o":["text"],
                "fa:file-video-o":["video"],
                "fa:file-audio-o":["audio"],
                "fa:file-excel-o":["excel"],
                "fa:file-powerpoint-o":["powerpoint"],
            },
            getIconForMime:function(mime){
                if(mime) {
                    for (var icon in this.iconsMimeKeyWords) {
                        var keywords = this.iconsMimeKeyWords[icon];
                        for (var i = 0; i < keywords.length; i++) {
                            if (mime.indexOf(keywords[i]) != -1) {
                                return icon;
                            }
                        }
                    }
                }
                return this.defaultIcon;
            }
        };
        Polymer("cg-input-documents", {
            label:null,
            required:false,
            selected:null,
            _decoratorElement:null,
            documents:[],
            _selection:null,
            warningSize:1024*1024*10,
            _cgFileManager:new CGFileManager(),
            _displayMimeIcon:function(mime){
                return this._cgFileManager.getIconForMime(mime);
            },
            _displaySize:function(size){
                var kb = 1024;
                var mb = kb*kb;
                console.log(size)
                if(size < kb) {
                    return (size).toFixed(2) + "b";
                }else if(size >= kb && size < mb) {
                    return (size / kb).toFixed(2) + "kb";
                }else{
                    return (size / mb).toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "mb";
                }
            },
            domReady:function(){
                if(this.parentElement.tagName.toLowerCase() == "paper-input-decorator") {
                    this._decoratorElement = this.parentElement; // _decoratorElement thing's quite nasty..
                    this.label = this._decoratorElement.getAttribute("label");
                }
                this._colors = [].slice.call(this.querySelectorAll(".color"));
//                this.selectedChanged();
            },
            _selectFiles:function(){
                this.$.input.click();
            },
            _selectionChange:function(e){
                console.log("_selectionChange: " + JSON.stringify(this._selection));
            },
            _neutralizeEvent:function(e){
                e.stopPropagation();
                e.preventDefault();
            },
            _onDragOver:function(e){
                this._neutralizeEvent(e);
                console.log("_onDragOver");
            },
            _onDragLeave:function(e){
                this._neutralizeEvent(e);
                console.log("_onDragLeave");
            },

            _onDrop:function(e){
                this._neutralizeEvent(e);
                var files = e.dataTransfer ? e.dataTransfer.files : e.currentTarget.files;
                //e.dataTransfer.items[0].webkitGetAsEntry()
                for(var i=0; i < files.length; i++){
                    var file = files.item(i);
                    if(!this.containsDoc(file)) {
                        this.documents.push({
                            name:file.name,
                            size:file.size,
                            type:file.type,
                            handle:file
                        });
                    }
                }
            },
            containsDoc:function(doc){
                for(var i = 0; i < this.documents.length; i++){
                    if(this.documents[i].name == doc.name){
                        return true;
                    }
                }
                return false;
            },
//            crawlDirectory:function(file, dept){
//                for(){
//
//                }
//            }

//            selectedChanged:function(){
//                this._colors.forEach(function(color){
//                    color.setZ(color.dataset.value == this.selected ? 3 : 0);
//                }.bind(this));
//                this._decoratorElement && this._decoratorElement.inputChanged();
//                this.fire('change', this.selected);
//            },
//            _selectionChanged:function(e){
//                this.selected = e.currentTarget.dataset.value;
//            }
        });
    </script>
</polymer-element>